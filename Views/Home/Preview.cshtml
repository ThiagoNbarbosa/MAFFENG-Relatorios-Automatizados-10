@model MAFFENG.Models.PreviewModel

@{
    ViewData["Title"] = "Preview do Relatório";
}

<div class="space-y-6">
    <!-- Header -->
    <div class="glass-card rounded-2xl p-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold">Preview do Relatório</h1>
                <p class="text-gray-300 mt-2">Projeto: @Model.FormData.NomeProjeto</p>
            </div>
            <div class="text-right">
                <div class="text-sm text-gray-300">Total de imagens:</div>
                <div class="text-2xl font-bold text-green-400" id="total-images">
                    @Model.PreviewItems.Sum(item => item.Images.Count)
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Content -->
    <div class="glass-card rounded-2xl p-6">
        <form asp-action="GenerateReport" method="post" id="preview-form">
            <div id="sortable-content" class="space-y-4">
                @{
                    int itemIndex = 0;
                }
                @foreach (var item in Model.PreviewItems)
                {
                    <!-- Folder Title -->
                    <div class="preview-item bg-blue-500/20 border border-blue-500/30 rounded-lg p-4" data-type="folder">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-grip-vertical text-gray-400 cursor-move"></i>
                                <i class="fas fa-folder text-blue-400"></i>
                                <span class="font-medium">@item.Title</span>
                                <span class="text-sm text-gray-400">(@item.Images.Count imagens)</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button type="button" class="text-gray-400 hover:text-white" onclick="toggleFolder(this)">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Hidden inputs for folder -->
                        <input type="hidden" name="item_type_@(itemIndex)" value="folder" />
                        <input type="hidden" name="item_title_@(itemIndex)" value="@item.Title" />
                        <input type="hidden" name="item_level_@(itemIndex)" value="@item.Level" />
                        
                        @{ itemIndex++; }
                        
                        <!-- Folder Images -->
                        <div class="folder-images mt-4 grid grid-cols-4 gap-4" style="display: block;">
                            @foreach (var image in item.Images)
                            {
                                <div class="preview-item image-item bg-gray-500/20 border border-gray-500/30 rounded-lg p-3" data-type="image">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <i class="fas fa-grip-vertical text-gray-400 cursor-move text-xs"></i>
                                        <i class="fas fa-image text-green-400 text-sm"></i>
                                        <span class="text-sm truncate">@image.Name</span>
                                    </div>
                                    
                                    <!-- Thumbnail -->
                                    <div class="relative">
                                        <img src="@Url.Action("Thumbnail", new { imagePath = image.Path })" 
                                             alt="@image.Name" 
                                             class="w-full h-20 object-cover rounded border border-gray-600"
                                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjNEI1NTYzIi8+CjxwYXRoIGQ9Ik0zNSA2NUw0NSA1NUw2MCA3MEw3NSA1NUw4NSA2NVY3NUgzNVY2NVoiIGZpbGw9IiM5Q0E5QjQiLz4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNSIgZmlsbD0iIzlDQTlCNCIvPgo8L3N2Zz4K'" />
                                        <div class="absolute inset-0 bg-black/50 opacity-0 hover:opacity-100 transition-opacity flex items-center justify-center">
                                            <button type="button" class="text-white hover:text-red-400" onclick="removeImage(this)">
                                                <i class="fas fa-trash text-sm"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Hidden inputs for image -->
                                    <input type="hidden" name="item_type_@(itemIndex)" value="image" />
                                    <input type="hidden" name="item_path_@(itemIndex)" value="@image.Path" />
                                </div>
                                
                                @{ itemIndex++; }
                            }
                        </div>
                    </div>
                }
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-between items-center mt-8">
                <a asp-action="Index" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Voltar
                </a>
                
                <div class="space-x-4">
                    <button type="button" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition-colors" onclick="updatePreview()">
                        <i class="fas fa-sync mr-2"></i>
                        Atualizar Preview
                    </button>
                    
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition-colors">
                        <i class="fas fa-file-word mr-2"></i>
                        Gerar Relatório Word
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        // Initialize Sortable for main content
        new Sortable(document.getElementById('sortable-content'), {
            handle: '.fa-grip-vertical',
            animation: 150,
            onEnd: function(evt) {
                updateIndexes();
            }
        });

        // Initialize Sortable for each folder's images
        document.querySelectorAll('.folder-images').forEach(folder => {
            new Sortable(folder, {
                handle: '.fa-grip-vertical',
                animation: 150,
                onEnd: function(evt) {
                    updateIndexes();
                }
            });
        });

        function toggleFolder(button) {
            const folderImages = button.closest('.preview-item').querySelector('.folder-images');
            const icon = button.querySelector('i');
            
            if (folderImages.style.display === 'none') {
                folderImages.style.display = 'block';
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-down');
            } else {
                folderImages.style.display = 'none';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-right');
            }
        }

        function removeImage(button) {
            if (confirm('Tem certeza que deseja remover esta imagem?')) {
                const imageItem = button.closest('.image-item');
                imageItem.remove();
                updateIndexes();
                updateImageCount();
            }
        }

        function updateIndexes() {
            const items = document.querySelectorAll('.preview-item');
            let index = 0;
            
            items.forEach(item => {
                const inputs = item.querySelectorAll('input[type="hidden"]');
                inputs.forEach(input => {
                    const name = input.name.replace(/_\d+$/, `_${index}`);
                    input.name = name;
                });
                index++;
            });
        }

        function updateImageCount() {
            const imageCount = document.querySelectorAll('.image-item').length;
            document.getElementById('total-images').textContent = imageCount;
        }

        function updatePreview() {
            updateIndexes();
            updateImageCount();
            
            // Show success message
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check mr-2"></i>Atualizado!';
            button.disabled = true;
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 2000);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateIndexes();
        });
    </script>
}